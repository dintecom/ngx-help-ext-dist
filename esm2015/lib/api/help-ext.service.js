import { HttpClient } from '@angular/common/http';
import { ElementRef, Inject, Injectable, SecurityContext } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { isObservable, of, throwError } from 'rxjs';
import { catchError, finalize, map, mergeMap, share, shareReplay, tap } from 'rxjs/operators';
import { HelpExtUrlResolver, HELP_EXT_CACHE_LIFETIME_TOKEN, HELP_EXT_HTTP_HEADERS, HELP_EXT_URL_TOKEN, } from '../help-ext.config';
export const cacheLifetimeSecondDefault = 30 * 60;
export class HelpExtService {
    constructor(helpExtUrlResolver, _http, _sanitizer, helpExtUrl, cacheLifetimeSecond, _httpHeaders) {
        this._http = _http;
        this._sanitizer = _sanitizer;
        this._httpHeaders = _httpHeaders;
        this.cacheById = {};
        this.requestCacheById = {};
        this.cacheByUid = {};
        this.requestCacheByUid = {};
        this.cacheByUrl = {};
        this.requestCacheByUrl = {};
        if (helpExtUrlResolver) {
            const resolved = helpExtUrlResolver.resolve();
            if (typeof resolved === 'string') {
                this.baseAddress = of(resolved).pipe(shareReplay(1));
            }
            else if (isObservable(resolved)) {
                this.baseAddress = resolved.pipe(shareReplay(1));
            }
            else {
                throw Error('Not supported helpExtUrlResolver');
            }
        }
        else if (helpExtUrl) {
            this.baseAddress = of(helpExtUrl).pipe(shareReplay(1));
        }
        else {
            throw Error('Please, configure helpExtUrl or helpExtUrlResolver');
        }
        this.cacheLifetime = cacheLifetimeSecond * 1000;
    }
    getArticleById(id) {
        return this.baseAddress.pipe(mergeMap(baseAddress => this.cachedGet(this.cacheById, this.requestCacheById, id, `${baseAddress}/api/Clients/GetArticleById/${id}`)));
    }
    getArticleByUid(siteOrigin, uid) {
        return this.baseAddress.pipe(mergeMap(baseAddress => this.cachedGet(this.cacheByUid, this.requestCacheByUid, uid, `${baseAddress}/api/Clients/GetArticleByUid?siteOrigin=${encodeURIComponent(siteOrigin)}&uid=${encodeURIComponent(uid)}`)));
    }
    getArticleByUrl(url) {
        return this.baseAddress.pipe(mergeMap(baseAddress => this.cachedGet(this.cacheByUrl, this.requestCacheByUrl, url, `${baseAddress}/api/Clients/GetArticleByUrl?url=${encodeURIComponent(url)}`)));
    }
    sanitizeContent(content) {
        return this._sanitizer.sanitize(SecurityContext.HTML, this._sanitizer.bypassSecurityTrustHtml(content));
    }
    makeAbsoluteLinks(element, baseAddress, linkTarget) {
        const el = element instanceof ElementRef ? element.nativeElement : element;
        const links = el.getElementsByTagName('a');
        for (let i = 0; i < links.length; i++) {
            if (linkTarget) {
                links[i].setAttribute('target', linkTarget);
            }
            let href = links[i].getAttribute('href');
            if (/(?:^[a-z][a-z0-9+.-]*:|\/\/)/.test(href))
                continue;
            href = `${baseAddress}/${href}`;
            links[i].setAttribute('href', href);
        }
    }
    cachedGet(cache, requestCache, key, httpUrl) {
        if (cache[key]) {
            return cache[key].error ? throwError(cache[key].error) : of(cache[key].article);
        }
        if (requestCache[key])
            return requestCache[key];
        const request = {};
        if (this._httpHeaders) {
            request.headers = this._httpHeaders;
        }
        requestCache[key] = this._http.get(httpUrl, request).pipe(map(a => a), tap(a => {
            delete requestCache[key];
            cache[key] = {
                article: a,
            };
        }), catchError(e => {
            delete requestCache[key];
            cache[key] = {
                error: e,
            };
            return throwError(e);
        }), finalize(() => {
            setTimeout(() => delete cache[key], this.cacheLifetime);
        }), share());
        return requestCache[key];
    }
}
HelpExtService.decorators = [
    { type: Injectable }
];
HelpExtService.ctorParameters = () => [
    { type: HelpExtUrlResolver },
    { type: HttpClient },
    { type: DomSanitizer },
    { type: String, decorators: [{ type: Inject, args: [HELP_EXT_URL_TOKEN,] }] },
    { type: Number, decorators: [{ type: Inject, args: [HELP_EXT_CACHE_LIFETIME_TOKEN,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [HELP_EXT_HTTP_HEADERS,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVscC1leHQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1oZWxwLWV4dC9zcmMvbGliL2FwaS9oZWxwLWV4dC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hGLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsWUFBWSxFQUFjLEVBQUUsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDaEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlGLE9BQU8sRUFFTCxrQkFBa0IsRUFDbEIsNkJBQTZCLEVBQzdCLHFCQUFxQixFQUNyQixrQkFBa0IsR0FDbkIsTUFBTSxvQkFBb0IsQ0FBQztBQVE1QixNQUFNLENBQUMsTUFBTSwwQkFBMEIsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDO0FBR2xELE1BQU0sT0FBTyxjQUFjO0lBWXpCLFlBQ0Usa0JBQXNDLEVBQ3JCLEtBQWlCLEVBQ2pCLFVBQXdCLEVBQ2IsVUFBa0IsRUFDUCxtQkFBMkIsRUFDbEIsWUFBZ0M7UUFKL0QsVUFBSyxHQUFMLEtBQUssQ0FBWTtRQUNqQixlQUFVLEdBQVYsVUFBVSxDQUFjO1FBR08saUJBQVksR0FBWixZQUFZLENBQW9CO1FBZmpFLGNBQVMsR0FBa0MsRUFBRSxDQUFDO1FBQzlDLHFCQUFnQixHQUEwQyxFQUFFLENBQUM7UUFDN0QsZUFBVSxHQUFtQyxFQUFFLENBQUM7UUFDaEQsc0JBQWlCLEdBQTJD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Q0FBQyxJQUFJLENBQ3ZELEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQVksQ0FBQyxFQUN0QixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDTixPQUFPLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN6QixLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUc7Z0JBQ1gsT0FBTyxFQUFFLENBQUM7YUFDWCxDQUFDO1FBQ0osQ0FBQyxDQUFDLEVBQ0YsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ2IsT0FBTyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDekIsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHO2dCQUNYLEtBQUssRUFBRSxDQUFDO2FBQ1QsQ0FBQztZQUNGLE9BQU8sVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZCLENBQUMsQ0FBQyxFQUNGLFFBQVEsQ0FBQyxHQUFHLEVBQUU7WUFDWixVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzFELENBQUMsQ0FBQyxFQUNGLEtBQUssRUFBRSxDQUNSLENBQUM7UUFFRixPQUFPLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMzQixDQUFDOzs7WUF0SUYsVUFBVTs7O1lBZFQsa0JBQWtCO1lBUFgsVUFBVTtZQUVWLFlBQVk7eUNBb0NoQixNQUFNLFNBQUMsa0JBQWtCO3lDQUN6QixNQUFNLFNBQUMsNkJBQTZCOzRDQUNwQyxNQUFNLFNBQUMscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEVsZW1lbnRSZWYsIEluamVjdCwgSW5qZWN0YWJsZSwgU2VjdXJpdHlDb250ZXh0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBEb21TYW5pdGl6ZXIgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcbmltcG9ydCB7IGlzT2JzZXJ2YWJsZSwgT2JzZXJ2YWJsZSwgb2YsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIGZpbmFsaXplLCBtYXAsIG1lcmdlTWFwLCBzaGFyZSwgc2hhcmVSZXBsYXksIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gIEhlbHBFeHRIdHRwSGVhZGVycyxcbiAgSGVscEV4dFVybFJlc29sdmVyLFxuICBIRUxQX0VYVF9DQUNIRV9MSUZFVElNRV9UT0tFTixcbiAgSEVMUF9FWFRfSFRUUF9IRUFERVJTLFxuICBIRUxQX0VYVF9VUkxfVE9LRU4sXG59IGZyb20gJy4uL2hlbHAtZXh0LmNvbmZpZyc7XG5pbXBvcnQgeyBBcnRpY2xlIH0gZnJvbSAnLi9hcnRpY2xlJztcblxuaW50ZXJmYWNlIElDYWNoZUVudHJ5IHtcbiAgYXJ0aWNsZT86IEFydGljbGU7XG4gIGVycm9yPzogYW55O1xufVxuXG5leHBvcnQgY29uc3QgY2FjaGVMaWZldGltZVNlY29uZERlZmF1bHQgPSAzMCAqIDYwO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgSGVscEV4dFNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGNhY2hlTGlmZXRpbWU6IG51bWJlcjtcblxuICBwcml2YXRlIHJlYWRvbmx5IGNhY2hlQnlJZDogeyBbaWQ6IG51bWJlcl06IElDYWNoZUVudHJ5IH0gPSB7fTtcbiAgcHJpdmF0ZSByZWFkb25seSByZXF1ZXN0Q2FjaGVCeUlkOiB7IFtpZDogbnVtYmVyXTogT2JzZXJ2YWJsZTxBcnRpY2xlPiB9ID0ge307XG4gIHByaXZhdGUgcmVhZG9ubHkgY2FjaGVCeVVpZDogeyBbdXJsOiBzdHJpbmddOiBJQ2FjaGVFbnRyeSB9ID0ge307XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVxdWVzdENhY2hlQnlVaWQ6IHsgW3VybDogc3RyaW5nXTogT2JzZXJ2YWJsZTxBcnRpY2xlPiB9ID0ge307XG4gIHByaXZhdGUgcmVhZG9ubHkgY2FjaGVCeVVybDogeyBbdXJsOiBzdHJpbmddOiBJQ2FjaGVFbnRyeSB9ID0ge307XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVxdWVzdENhY2hlQnlVcmw6IHsgW3VybDogc3RyaW5nXTogT2JzZXJ2YWJsZTxBcnRpY2xlPiB9ID0ge307XG5cbiAgcmVhZG9ubHkgYmFzZUFkZHJlc3M6IE9ic2VydmFibGU8c3RyaW5nPjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBoZWxwRXh0VXJsUmVzb2x2ZXI6IEhlbHBFeHRVcmxSZXNvbHZlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9odHRwOiBIdHRwQ2xpZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgX3Nhbml0aXplcjogRG9tU2FuaXRpemVyLFxuICAgIEBJbmplY3QoSEVMUF9FWFRfVVJMX1RPS0VOKSBoZWxwRXh0VXJsOiBzdHJpbmcsXG4gICAgQEluamVjdChIRUxQX0VYVF9DQUNIRV9MSUZFVElNRV9UT0tFTikgY2FjaGVMaWZldGltZVNlY29uZDogbnVtYmVyLFxuICAgIEBJbmplY3QoSEVMUF9FWFRfSFRUUF9IRUFERVJTKSBwcml2YXRlIHJlYWRvbmx5IF9odHRwSGVhZGVyczogSGVscEV4dEh0dHBIZWFkZXJzLFxuICApIHtcbiAgICBpZiAoaGVscEV4dFVybFJlc29sdmVyKSB7XG4gICAgICBjb25zdCByZXNvbHZlZCA9IGhlbHBFeHRVcmxSZXNvbHZlci5yZXNvbHZlKCk7XG4gICAgICBpZiAodHlwZW9mIHJlc29sdmVkID09PSAnc3RyaW5nJykge1xuICAgICAgICB0aGlzLmJhc2VBZGRyZXNzID0gb2YocmVzb2x2ZWQpLnBpcGUoc2hhcmVSZXBsYXkoMSkpO1xuICAgICAgfSBlbHNlIGlmIChpc09ic2VydmFibGUocmVzb2x2ZWQpKSB7XG4gICAgICAgIHRoaXMuYmFzZUFkZHJlc3MgPSByZXNvbHZlZC5waXBlKHNoYXJlUmVwbGF5KDEpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IEVycm9yKCdOb3Qgc3VwcG9ydGVkIGhlbHBFeHRVcmxSZXNvbHZlcicpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoaGVscEV4dFVybCkge1xuICAgICAgdGhpcy5iYXNlQWRkcmVzcyA9IG9mKGhlbHBFeHRVcmwpLnBpcGUoc2hhcmVSZXBsYXkoMSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBFcnJvcignUGxlYXNlLCBjb25maWd1cmUgaGVscEV4dFVybCBvciBoZWxwRXh0VXJsUmVzb2x2ZXInKTtcbiAgICB9XG5cbiAgICB0aGlzLmNhY2hlTGlmZXRpbWUgPSBjYWNoZUxpZmV0aW1lU2Vjb25kICogMTAwMDtcbiAgfVxuXG4gIGdldEFydGljbGVCeUlkKGlkOiBudW1iZXIpOiBPYnNlcnZhYmxlPEFydGljbGU+IHtcbiAgICByZXR1cm4gdGhpcy5iYXNlQWRkcmVzcy5waXBlKFxuICAgICAgbWVyZ2VNYXAoYmFzZUFkZHJlc3MgPT5cbiAgICAgICAgdGhpcy5jYWNoZWRHZXQodGhpcy5jYWNoZUJ5SWQsIHRoaXMucmVxdWVzdENhY2hlQnlJZCwgaWQsIGAke2Jhc2VBZGRyZXNzfS9hcGkvQ2xpZW50cy9HZXRBcnRpY2xlQnlJZC8ke2lkfWApLFxuICAgICAgKSxcbiAgICApO1xuICB9XG5cbiAgZ2V0QXJ0aWNsZUJ5VWlkKHNpdGVPcmlnaW46IHN0cmluZywgdWlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEFydGljbGU+IHtcbiAgICByZXR1cm4gdGhpcy5iYXNlQWRkcmVzcy5waXBlKFxuICAgICAgbWVyZ2VNYXAoYmFzZUFkZHJlc3MgPT5cbiAgICAgICAgdGhpcy5jYWNoZWRHZXQoXG4gICAgICAgICAgdGhpcy5jYWNoZUJ5VWlkLFxuICAgICAgICAgIHRoaXMucmVxdWVzdENhY2hlQnlVaWQsXG4gICAgICAgICAgdWlkLFxuICAgICAgICAgIGAke2Jhc2VBZGRyZXNzfS9hcGkvQ2xpZW50cy9HZXRBcnRpY2xlQnlVaWQ/c2l0ZU9yaWdpbj0ke2VuY29kZVVSSUNvbXBvbmVudChcbiAgICAgICAgICAgIHNpdGVPcmlnaW4sXG4gICAgICAgICAgKX0mdWlkPSR7ZW5jb2RlVVJJQ29tcG9uZW50KHVpZCl9YCxcbiAgICAgICAgKSxcbiAgICAgICksXG4gICAgKTtcbiAgfVxuXG4gIGdldEFydGljbGVCeVVybCh1cmw6IHN0cmluZyk6IE9ic2VydmFibGU8QXJ0aWNsZT4ge1xuICAgIHJldHVybiB0aGlzLmJhc2VBZGRyZXNzLnBpcGUoXG4gICAgICBtZXJnZU1hcChiYXNlQWRkcmVzcyA9PlxuICAgICAgICB0aGlzLmNhY2hlZEdldChcbiAgICAgICAgICB0aGlzLmNhY2hlQnlVcmwsXG4gICAgICAgICAgdGhpcy5yZXF1ZXN0Q2FjaGVCeVVybCxcbiAgICAgICAgICB1cmwsXG4gICAgICAgICAgYCR7YmFzZUFkZHJlc3N9L2FwaS9DbGllbnRzL0dldEFydGljbGVCeVVybD91cmw9JHtlbmNvZGVVUklDb21wb25lbnQodXJsKX1gLFxuICAgICAgICApLFxuICAgICAgKSxcbiAgICApO1xuICB9XG5cbiAgc2FuaXRpemVDb250ZW50KGNvbnRlbnQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX3Nhbml0aXplci5zYW5pdGl6ZShTZWN1cml0eUNvbnRleHQuSFRNTCwgdGhpcy5fc2FuaXRpemVyLmJ5cGFzc1NlY3VyaXR5VHJ1c3RIdG1sKGNvbnRlbnQpKTtcbiAgfVxuXG4gIG1ha2VBYnNvbHV0ZUxpbmtzKGVsZW1lbnQ6IEVsZW1lbnQgfCBFbGVtZW50UmVmLCBiYXNlQWRkcmVzczogc3RyaW5nLCBsaW5rVGFyZ2V0Pzogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgZWwgPSBlbGVtZW50IGluc3RhbmNlb2YgRWxlbWVudFJlZiA/IChlbGVtZW50Lm5hdGl2ZUVsZW1lbnQgYXMgRWxlbWVudCkgOiBlbGVtZW50O1xuXG4gICAgY29uc3QgbGlua3MgPSBlbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYScpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlua3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChsaW5rVGFyZ2V0KSB7XG4gICAgICAgIGxpbmtzW2ldLnNldEF0dHJpYnV0ZSgndGFyZ2V0JywgbGlua1RhcmdldCk7XG4gICAgICB9XG5cbiAgICAgIGxldCBocmVmID0gbGlua3NbaV0uZ2V0QXR0cmlidXRlKCdocmVmJyk7XG4gICAgICBpZiAoLyg/Ol5bYS16XVthLXowLTkrLi1dKjp8XFwvXFwvKS8udGVzdChocmVmKSkgY29udGludWU7XG5cbiAgICAgIGhyZWYgPSBgJHtiYXNlQWRkcmVzc30vJHtocmVmfWA7XG4gICAgICBsaW5rc1tpXS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBocmVmKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNhY2hlZEdldChcbiAgICBjYWNoZTogeyBbaWQ6IG51bWJlcl06IElDYWNoZUVudHJ5IH0gfCB7IFt1cmw6IHN0cmluZ106IElDYWNoZUVudHJ5IH0sXG4gICAgcmVxdWVzdENhY2hlOiB7IFtpZDogbnVtYmVyXTogT2JzZXJ2YWJsZTxBcnRpY2xlPiB9IHwgeyBbaWQ6IG51bWJlcl06IE9ic2VydmFibGU8QXJ0aWNsZT4gfSxcbiAgICBrZXk6IG51bWJlciB8IHN0cmluZyxcbiAgICBodHRwVXJsOiBzdHJpbmcsXG4gICk6IE9ic2VydmFibGU8QXJ0aWNsZT4ge1xuICAgIGlmIChjYWNoZVtrZXldKSB7XG4gICAgICByZXR1cm4gY2FjaGVba2V5XS5lcnJvciA/IHRocm93RXJyb3IoY2FjaGVba2V5XS5lcnJvcikgOiBvZihjYWNoZVtrZXldLmFydGljbGUpO1xuICAgIH1cblxuICAgIGlmIChyZXF1ZXN0Q2FjaGVba2V5XSkgcmV0dXJuIHJlcXVlc3RDYWNoZVtrZXldO1xuXG4gICAgY29uc3QgcmVxdWVzdDogeyBoZWFkZXJzPzogSGVscEV4dEh0dHBIZWFkZXJzIH0gPSB7fTtcbiAgICBpZiAodGhpcy5faHR0cEhlYWRlcnMpIHtcbiAgICAgIHJlcXVlc3QuaGVhZGVycyA9IHRoaXMuX2h0dHBIZWFkZXJzO1xuICAgIH1cbiAgICByZXF1ZXN0Q2FjaGVba2V5XSA9IHRoaXMuX2h0dHAuZ2V0KGh0dHBVcmwsIHJlcXVlc3QpLnBpcGUoXG4gICAgICBtYXAoYSA9PiBhIGFzIEFydGljbGUpLFxuICAgICAgdGFwKGEgPT4ge1xuICAgICAgICBkZWxldGUgcmVxdWVzdENhY2hlW2tleV07XG4gICAgICAgIGNhY2hlW2tleV0gPSB7XG4gICAgICAgICAgYXJ0aWNsZTogYSxcbiAgICAgICAgfTtcbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcihlID0+IHtcbiAgICAgICAgZGVsZXRlIHJlcXVlc3RDYWNoZVtrZXldO1xuICAgICAgICBjYWNoZVtrZXldID0ge1xuICAgICAgICAgIGVycm9yOiBlLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlKTtcbiAgICAgIH0pLFxuICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGRlbGV0ZSBjYWNoZVtrZXldLCB0aGlzLmNhY2hlTGlmZXRpbWUpO1xuICAgICAgfSksXG4gICAgICBzaGFyZSgpLFxuICAgICk7XG5cbiAgICByZXR1cm4gcmVxdWVzdENhY2hlW2tleV07XG4gIH1cbn1cbiJdfQ==